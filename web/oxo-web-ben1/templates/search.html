{% extends "base.html" %}

{% block title %}Search - Jira Integration Demo{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1 class="display-6">
            <i class="bi bi-search text-primary"></i> Search Issues
        </h1>
        <p class="text-muted">Use Jira Query Language (JQL) to search for issues</p>
    </div>
</div>

<!-- Search Form -->
<div class="card shadow-sm mb-4">
    <div class="card-body">
        <form method="GET" action="{{ url_for('search') }}">
            <div class="row g-3">
                <div class="col-md-9">
                    <label for="jql" class="form-label">JQL Query</label>
                    <input type="text" 
                           class="form-control" 
                           id="jql" 
                           name="jql" 
                           value="{{ jql }}"
                           placeholder="e.g., project = MYPROJECT AND status = 'In Progress'"
                           required>
                    <div class="form-text">
                        Enter a JQL query to search for issues. 
                        <a href="https://support.atlassian.com/jira-software-cloud/docs/use-advanced-search-with-jira-query-language-jql/" 
                           target="_blank">
                            Learn JQL <i class="bi bi-box-arrow-up-right"></i>
                        </a>
                    </div>
                </div>
                <div class="col-md-3">
                    <label for="max_results" class="form-label">Max Results</label>
                    <select class="form-select" id="max_results" name="max_results">
                        <option value="10">10</option>
                        <option value="25">25</option>
                        <option value="50" selected>50</option>
                        <option value="100">100</option>
                    </select>
                </div>
            </div>
            <div class="mt-3">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-search"></i> Search
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="clearSearch()">
                    <i class="bi bi-x-circle"></i> Clear
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Common JQL Examples -->
<div class="card shadow-sm mb-4">
    <div class="card-header bg-light">
        <h6 class="mb-0"><i class="bi bi-lightbulb"></i> Common JQL Examples</h6>
    </div>
    <div class="card-body">
        <div class="row g-2">
            <div class="col-md-6">
                <button class="btn btn-sm btn-outline-secondary w-100 text-start" 
                        onclick="setJQL('assignee = currentUser() ORDER BY created DESC')">
                    My assigned issues
                </button>
            </div>
            <div class="col-md-6">
                <button class="btn btn-sm btn-outline-secondary w-100 text-start" 
                        onclick="setJQL('status = \'In Progress\' ORDER BY updated DESC')">
                    Issues in progress
                </button>
            </div>
            <div class="col-md-6">
                <button class="btn btn-sm btn-outline-secondary w-100 text-start" 
                        onclick="setJQL('priority = High ORDER BY created DESC')">
                    High priority issues
                </button>
            </div>
            <div class="col-md-6">
                <button class="btn btn-sm btn-outline-secondary w-100 text-start" 
                        onclick="setJQL('created >= -7d ORDER BY created DESC')">
                    Created in last 7 days
                </button>
            </div>
            <div class="col-md-6">
                <button class="btn btn-sm btn-outline-secondary w-100 text-start" 
                        onclick="setJQL('status = Done AND resolved >= -30d')">
                    Resolved in last 30 days
                </button>
            </div>
            <div class="col-md-6">
                <button class="btn btn-sm btn-outline-secondary w-100 text-start" 
                        onclick="setJQL('assignee is EMPTY ORDER BY created DESC')">
                    Unassigned issues
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Results -->
{% if jql %}
    {% if issues %}
        <div class="card shadow-sm">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="bi bi-check-circle"></i> Search Results
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 15%;">Key</th>
                                <th style="width: 40%;">Summary</th>
                                <th style="width: 15%;">Status</th>
                                <th style="width: 15%;">Priority</th>
                                <th style="width: 15%;">Assignee</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for issue in issues %}
                                <tr>
                                    <td>
                                        <a href="{{ url_for('issue_detail', issue_key=issue.key) }}" 
                                           class="text-decoration-none fw-bold">
                                            {{ issue.key }}
                                        </a>
                                    </td>
                                    <td>
                                        <a href="{{ url_for('issue_detail', issue_key=issue.key) }}" 
                                           class="text-decoration-none text-dark">
                                            {{ issue.fields.summary }}
                                        </a>
                                    </td>
                                    <td>
                                        {% if issue.fields.status %}
                                            <span class="badge 
                                                {% if issue.fields.status.name == 'Done' %}bg-success
                                                {% elif issue.fields.status.name == 'In Progress' %}bg-primary
                                                {% elif issue.fields.status.name == 'To Do' %}bg-secondary
                                                {% else %}bg-info{% endif %}">
                                                {{ issue.fields.status.name }}
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if issue.fields.priority %}
                                            {% if issue.fields.priority.iconUrl %}
                                                <img src="{{ issue.fields.priority.iconUrl }}" 
                                                     alt="{{ issue.fields.priority.name }}"
                                                     style="width: 16px; height: 16px;">
                                            {% endif %}
                                            <small>{{ issue.fields.priority.name }}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if issue.fields.assignee %}
                                            <small>{{ issue.fields.assignee.displayName }}</small>
                                        {% else %}
                                            <small class="text-muted">Unassigned</small>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer bg-light">
                <small class="text-muted">
                    Found {{ total }} issue(s) matching your query
                </small>
            </div>
        </div>
    {% else %}
        <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle"></i>
            <strong>No results found.</strong>
            Try adjusting your JQL query.
        </div>
    {% endif %}
{% endif %}

<div class="row mt-4">
    <div class="col">
        <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back to Home
        </a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function setJQL(query) {
        document.getElementById('jql').value = query;
    }
    
    function clearSearch() {
        document.getElementById('jql').value = '';
    }
</script>
{% endblock %}